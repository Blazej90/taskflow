<header class="header" *ngIf="!selectMode(); else selectionToolbar">
  <h1>Tasks</h1>

  <div class="header-actions">
    <div class="segmented">
      <button
        type="button"
        class="segmented-btn"
        [class.active]="viewMode() === 'list'"
        (click)="setViewMode('list')"
        [disabled]="loading()"
      >
        List
      </button>
      <button
        type="button"
        class="segmented-btn"
        [class.active]="viewMode() === 'board'"
        (click)="setViewMode('board')"
        [disabled]="loading()"
      >
        Board
      </button>
    </div>

    <button class="btn ghost" type="button" (click)="toggleSelectMode()" [disabled]="loading()">
      Select
    </button>

    <a
      class="btn"
      routerLink="/tasks/new"
      [class.disabled]="loading()"
      [attr.aria-disabled]="loading()"
    >
      + New task
    </a>
  </div>
</header>

<ng-template #selectionToolbar>
  <header class="selection-toolbar">
    <div class="left">
      <button
        class="icon-btn"
        type="button"
        (click)="toggleSelectMode()"
        aria-label="Cancel selection"
      >
        âœ•
      </button>

      <span class="selection-pill">
        <strong>{{ selectedCount() }}</strong> selected
      </span>
    </div>

    <div class="right">
      <button
        class="action-btn"
        type="button"
        (click)="bulkMarkDone()"
        [disabled]="selectedCount() === 0"
        title="Mark selected as done"
      >
        âœ“ Done
      </button>

      <button
        class="action-btn danger"
        type="button"
        (click)="bulkDelete()"
        [disabled]="selectedCount() === 0"
        title="Delete selected"
      >
        ðŸ—‘ Delete
      </button>
    </div>
  </header>
</ng-template>

<span *ngIf="selectMode()" style="margin-left: 12px"> Selected: {{ selectedCount() }} </span>

<div class="filters">
  <button
    type="button"
    class="chip"
    [class.active]="statusFilter() === 'all'"
    [disabled]="loading()"
    (click)="setFilter('all')"
  >
    All ({{ totalCount() }})
  </button>
  <button
    type="button"
    class="chip"
    [class.active]="statusFilter() === 'todo'"
    [disabled]="loading()"
    (click)="setFilter('todo')"
  >
    Todo ({{ todoCount() }})
  </button>
  <button
    type="button"
    class="chip"
    [class.active]="statusFilter() === 'doing'"
    [disabled]="loading()"
    (click)="setFilter('doing')"
  >
    Doing ({{ doingCount() }})
  </button>
  <button
    type="button"
    class="chip"
    [class.active]="statusFilter() === 'done'"
    [disabled]="loading()"
    (click)="setFilter('done')"
  >
    Done ({{ doneCount() }})
  </button>
</div>

<div class="search-row">
  <mat-form-field appearance="outline" class="search-field">
    <mat-label>Search</mat-label>
    <input
      matInput
      type="text"
      placeholder="Search tasks by title..."
      [disabled]="loading()"
      [ngModel]="searchTerm()"
      (ngModelChange)="searchTerm.set($event)"
    />
  </mat-form-field>

  <mat-form-field appearance="outline" class="sort-field">
    <mat-label>Sort</mat-label>
    <mat-select [ngModel]="sortBy()" (ngModelChange)="sortBy.set($event)">
      <mat-option value="manual">Manual (drag)</mat-option>
      <mat-option value="newest">Newest first</mat-option>
      <mat-option value="oldest">Oldest first</mat-option>
      <mat-option value="status">Status</mat-option>
    </mat-select>
  </mat-form-field>
</div>

<div class="view-switch">
  <button
    class="btn ghost"
    type="button"
    (click)="viewMode.set('list')"
    [class.active]="viewMode() === 'list'"
  >
    List
  </button>

  <button
    class="btn ghost"
    type="button"
    (click)="viewMode.set('board')"
    [class.active]="viewMode() === 'board'"
  >
    Board
  </button>
</div>
<p *ngIf="!isManualOrder()" class="hint">
  Reordering is available only in <strong>Oldest first</strong> mode.
</p>
<section
  *ngIf="viewMode() === 'list'; else boardView"
  class="list"
  cdkDropList
  [cdkDropListDisabled]="!isManualOrder()"
  (cdkDropListDropped)="onDrop($event)"
>
  <div
    *ngFor="let t of filteredTasks(); let i = index"
    class="draggable-row"
    cdkDrag
    [cdkDragDisabled]="!isManualOrder()"
  >
    <app-task-card
      [task]="t"
      [selectable]="selectMode()"
      [selected]="isSelected(t.id)"
      (selectedChange)="onSelectedChange($event)"
      (remove)="removeTask($event)"
      (toggle)="toggleTaskStatus($event)"
    ></app-task-card>
  </div>
</section>
<ng-template #boardView>
  <div class="board">
    <div class="col">
      <div class="col-title">Todo</div>

      <div
        class="col-list"
        cdkDropList
        [cdkDropListData]="boardTodo()"
        [cdkDropListConnectedTo]="['doingList', 'doneList']"
        (cdkDropListDropped)="onBoardDrop('todo', $event)"
        id="todoList"
      >
        <div *ngFor="let t of boardTodo()" cdkDrag class="draggable-row">
          <app-task-card
            [task]="t"
            [selectable]="selectMode()"
            [selected]="isSelected(t.id)"
            (selectedChange)="onSelectedChange($event)"
            (remove)="removeTask($event)"
            (toggle)="toggleTaskStatus($event)"
          ></app-task-card>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="col-title">Doing</div>

      <div
        class="col-list"
        cdkDropList
        [cdkDropListData]="boardDoing()"
        [cdkDropListConnectedTo]="['todoList', 'doneList']"
        (cdkDropListDropped)="onBoardDrop('doing', $event)"
        id="doingList"
      >
        <div *ngFor="let t of boardDoing()" cdkDrag class="draggable-row">
          <app-task-card
            [task]="t"
            [selectable]="selectMode()"
            [selected]="isSelected(t.id)"
            (selectedChange)="onSelectedChange($event)"
            (remove)="removeTask($event)"
            (toggle)="toggleTaskStatus($event)"
          ></app-task-card>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="col-title">Done</div>

      <div
        class="col-list"
        cdkDropList
        [cdkDropListData]="boardDone()"
        [cdkDropListConnectedTo]="['todoList', 'doingList']"
        (cdkDropListDropped)="onBoardDrop('done', $event)"
        id="doneList"
      >
        <div *ngFor="let t of boardDone()" cdkDrag class="draggable-row">
          <app-task-card
            [task]="t"
            [selectable]="selectMode()"
            [selected]="isSelected(t.id)"
            (selectedChange)="onSelectedChange($event)"
            (remove)="removeTask($event)"
            (toggle)="toggleTaskStatus($event)"
          ></app-task-card>
        </div>
      </div>
    </div>
  </div>
</ng-template>
<div *ngIf="isEmpty()" class="empty">
  <h3>No tasks here ðŸ‘€</h3>
  <p>Create a new task or change the filter.</p>
  <a class="btn" routerLink="/tasks/new">+ New task</a>
</div>
